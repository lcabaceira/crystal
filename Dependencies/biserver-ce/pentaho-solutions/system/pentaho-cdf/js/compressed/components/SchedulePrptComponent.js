define(["./SchedulePrptComponent.ext","./PrptComponent","../lib/jquery","amd!../lib/jquery.impromptu","css!./SchedulePrptComponent"],function(e,t,a){var n=t.extend({visible:!1,update:function(){var e=this,t=this.placeholder();
t[0]&&a.inArray(t[0].tagName.toUpperCase(),["SPAN","DIV"])>-1&&(t=a("<button/>").appendTo(t.empty()),"DIV"==t[0].tagName&&t.wrap("<span/>"),void 0!=this.label&&t.text(this.label),t.button(),t.addClass("scheduler_button")),t.unbind("click"),t.bind("click",function(){var t="undefined"==typeof e.preChange?!0:e.preChange();
t&&e.schedulePrptComponent(),"undefined"!=typeof e.postChange&&e.postChange()})},schedulePrptComponent:function(){var t,n={},i=!1,r=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,a="x"==e?t:3&t|8;
return a.toString(16)})},o=function(e,t){i=!0,a(t).css("backgroundColor","rgb(255,159,159)");
var n=a(t).val();a(t).val(e),setTimeout(function(){a(t).css("backgroundColor","white"),a(t).val(n)
},2e3)},l=function(){var e=S.path;return e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))
},s=function(){return"/home/"+S.dashboard.context.user},d=function(){var e=a("#hours").val();
return"pm"==a("#amPm").val()?(e=parseInt(e,10)+12,24==e&&(e=12)):"12"==e&&(e=0),e
},p=function(e,t){var a=e.split("/");return t?new Date(a[2],a[0]-1,a[1],23,59,59,0).getTime():new Date(a[2],a[0]-1,a[1],0,0,0,0).getTime()
},u=function(e){var t=e.split("/");return new Date(t[2],t[0]-1,t[1],0,0,0,0).toISOString()
},c=function(e,t,a,n){for(var i='<select id ="'+n+'">',r=e;t>=r;r+=a)i+=10>r?'<option value="'+r+'">0'+r+"</option>":'<option value="'+r+'">'+r+"</option>";
return i+="</select>"},y=function(e,t){var a=new Date;(isNaN(e)||e<a.getTime())&&o("Incorrect Date, pick date from calendar",t)
},m=function(e,t){if(a("#endByRadio").is(":checked")){var n=new Date,i=a("#rangeStartIn").val(),r=p(i);
isNaN(r)||(r>e?o("End Date > Start Date",t):(isNaN(e)||e<n.getTime())&&o("Incorrect Date",t))
}},v=function(e){""==e&&o("You must choose a name","#nameIn");var t=/[^0-9a-zA-Z ]/;
e.match(t)&&o("Invalid characters, alpha-numeric text only.","#nameIn")},b=function(e){var t,n=d(),i=a("#minutes").val(),r=6e4*i+36e5*n;
return void 0!=e?(t=p(a(e).val())+r,y(t,e)):(t=p(a("#rangeStartIn").val())+r,y(t,"#rangeStartIn")),new Date(t).toISOString()
},h=function(){var e=p(a("#endByIn").val(),!0);return m(e,"#endByIn"),new Date(e).toISOString()
},f=function(){var e=new Array,t=0;return a("#sunday").is(":checked")&&(e[t++]=0),a("#monday").is(":checked")&&(e[t++]=1),a("#tuesday").is(":checked")&&(e[t++]=2),a("#wednesday").is(":checked")&&(e[t++]=3),a("#thursday").is(":checked")&&(e[t++]=4),a("#friday").is(":checked")&&(e[t++]=5),a("#saturday").is(":checked")&&(e[t++]=6),e
},g=function(){var e=a("#recurrPatternIn").val();return 1>e?o(">0","#recurrPatternIn"):e>31&&o("<=31","#recurrPatternIn"),e
},k=function(){n={inputFile:S.path,jobName:a("#nameIn").val(),outputFile:a("#locationIn").val()},i=!1;
var e=a("#recurrId").val(),t=a("#nameIn").val();switch(v(t),e){case"once":var r=b("#startDateIn"),l={repeatCount:0,repeatInterval:0,startTime:r,uiPassParam:"RUN_ONCE"};
n.simpleJobTrigger=l;break;case"seconds":var r=b(),s=a("#recurrPatternInSec").val();
if(1>s&&o(">0","#recurrPatternInSec"),a("#endByRadio").is(":checked"))var d=h();var l={endTime:d,repeatCount:-1,repeatInterval:s,startTime:r,uiPassParam:"SECONDS"};
n.simpleJobTrigger=l;break;case"minutes":var r=b(),p=a("#recurrPatternInMin").val();
if(1>p&&o(">0","#recurrPatternInMin"),a("#endByRadio").is(":checked"))var d=h();var l={endTime:d,repeatCount:-1,repeatInterval:60*p,startTime:r,uiPassParam:"MINUTES"};
n.simpleJobTrigger=l;break;case"hours":var r=b(),c=a("#recurrPatternInHour").val();
if(1>c&&o(">0","#recurrPatternInHour"),a("#endByRadio").is(":checked"))var d=h();
var l={endTime:d,repeatCount:-1,repeatInterval:3600*c,startTime:r,uiPassParam:"HOURS"};
n.simpleJobTrigger=l;break;case"daily":if(a("#endByRadio").is(":checked"))var d=h();
var r=b();if(a("#weekDayRadio").is(":checked")){var y={daysOfWeek:[1,2,3,4,5],endTime:d,startTime:r,uiPassParam:"DAILY"};
n.complexJobTrigger=y}else if(a("#dayRadio").is(":checked")){var m=a("#recurrPatternInDay").val();
1>m&&o(">0","#recurrPatternInDay");var l={entTime:d,repeatCount:-1,repeatInterval:86400*m,startTime:r,uiPassParam:"DAILY"};
n.simpleJobTrigger=l}break;case"weekly":var r=b();if(a("#endByRadio").is(":checked"))var d=h();
var y={daysOfWeek:f(),endTime:d,startTime:r,uiPassParam:"WEEKLY"};n.complexJobTrigger=y;
break;case"monthly":var r=b();if(a("#endByRadio").is(":checked"))var d=h();var y={endTime:d,startTime:r,uiPassParam:"MONTHLY"};
a("#monthRadio").is(":checked")?y.daysOfMonth=g():(y.daysOfWeek=a("#monthOpt2Select").val(),y.weeksOfMonth=a("#monthOpt1Select").val()),n.complexJobTrigger=y;
break;case"yearly":var r=b();if(a("#endByRadio").is(":checked"))var d=h();var y={endTime:d,startTime:r,uiPassParam:"YEARLY"};
a("#yearRadio").is(":checked")?(y.daysOfMonth=g(),y.monthsOfYear=a("#yearEveryMonth").val()):(y.daysOfWeek=a("#yearOpt2Select").val(),y.monthsOfYear=a("#yearMonthSelect").val(),y.weeksOfMonth=a("#yearOpt1Select").val()),n.complexJobTrigger=y;
break;case"cron":var k=a("#cronString").val();x(k);var r=u(a("#rangeStartIn").val());
a("#endByRadio").is(":checked")&&(d=h());var I={cronString:k,endTime:d,startTime:r,uiPassParam:"CRON"};
n.cronJobTrigger=I}},x=function(e){var t=e.split(" ");t.length<7?o("Cron Expression too short","#cronString"):t.length>7?o("Cron Expression too long","#cronString"):"?"!=t[3]&&"*"!=t[3]&&"?"!=t[5]&&"*"!=t[5]&&o("M+W unsupported.(M+? or W+?)","#cronString")
},I=function(e,t,a,n){return n||void 0==S.getReportOptions()[e]?{name:e,stringValue:new Array(""+t),type:a}:{name:e,stringValue:new Array(""+S.getReportOptions()[e]),type:a}
},S=this,w='<option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option>',T='<option value="0">sunday</option><option value="1">monday</option><option value="2">tuesday</option><option value="3">wednesday</option><option value="4">thursday</option><option value="5">friday</option><option value="6">saturday</option>',D='<option value="0">first</option><option value="1">second</option><option value="2">third</option><option value="3">fourth</option><option value="4">last</option>',P='<div id="nameDiv"><form style="display:inline-block" id="nameForm"><span class="dialog-label">Name:</span><input id="nameIn" type="text" value="'+l()+'"></form></div>',C='<div id="locationDiv"><form style="display:inline-block" id="nameForm"><span class="dialog-label">Location:</span><input id="locationIn" type="text" value="'+s()+'"></form></div>',O='<div id = "recurrenceDiv"><br><span class="dialog-title" style="width: 100px; display: inline-block;">Recurrence:</span><select id="recurrId" onChange="changeOpts()" style="margin-left: 0px;"><option value = "once" selected>Run Once</option><option value = "seconds">Seconds</option><option value = "minutes">Minutes</option><option value = "hours">Hours</option><option value = "daily">Daily</option><option value = "weekly">Weekly</option><option value = "monthly">Monthly</option><option value = "yearly">Yearly</option><option value = "cron">Cron</option></select></br></div>',M='<div id="cronDiv"  style="display:none"><form><span class="dialog-label">Cron String:</span><input id="cronString" type="text" value=""></form></div>',R=c(1,12,1,"hours"),E=c(0,59,1,"minutes"),N='<select id = "amPm"><option value="am">AM</option><option value="pm">PM</option></select>',A='<div id="startTimeDiv"><br><span class="dialog-title" style="width: 100px; display: inline-block;">Start Time:</span>'+R+E+N+"</div>",_='<div id="recurrPatternDiv" style = "display:none"><div id="patternSec" ><label style="display:inline-block; margin-left: 100px; font-weight: 500;">Every</label>&nbsp;&nbsp;<form style="display:inline-block"><input id= "recurrPatternInSec" type="text" size="3" style="width:30px;"></form><label style="display:inline-block; font-weight: 500;"> second(s)</label></div><div id="patternMin" ><label style="display:inline-block; margin-left: 100px; font-weight: 500;">Every</label>&nbsp;&nbsp;<form style="display:inline-block"><input id= "recurrPatternInMin" type="text" size="3" style="width:30px;"></form><label style="display:inline-block; font-weight: 500;"> minute(s)</label></div><div id="patternHour" ><label style="display:inline-block; margin-left: 100px; font-weight: 500;">Every</label>&nbsp;&nbsp;<form style="display:inline-block"><input id= "recurrPatternInHour" type="text" size="3" style="width:30px;"></form><label style="display:inline-block; font-weight: 500;"> hour(s)</label></div><div id="patternDay" ><input type="radio" name ="day" value="day" id="dayRadio" style="margin-left: 100px; font-weight: 500;" checked> <label style="display:inline-block">Every</label>&nbsp;&nbsp;<form style="display:inline-block"><input id= "recurrPatternInDay" type="text" size="3" style="width:30px;"></form><label style="display:inline-block; font-weight: 500;"> day(s)</label></br><input type="radio" name ="day" value="weekDay" id="weekDayRadio" style="margin-left: 100px;"> Every weekday</div><div id="patternWeek" ><form><div id="errorCheckboxes" style="display:none"><label id="errWeek">Choose at least one week</label></div><input type="checkbox" name="weekday" value="monday" id="monday" style="margin-left: 100px;"> Monday<input type="checkbox" name="weekday" value="tuesday" id="tuesday"> Tuesday<input type="checkbox" name="weekday" value="wednesday" id="wednesday"> Wednesday<input type="checkbox" name="weekday" value="thursday" id="thursday"> Thursday</br><input type="checkbox" name="weekday" value="friday" id="friday" style="margin-left: 100px;"> Friday<input type="checkbox" name="weekday" value="saturday" id="saturday"> Saturday<input type="checkbox" name="weekday" value="sunday" id="sunday"> Sunday</form></div><div id="patternMonth" ><input id="monthRadio" type="radio" name ="month" value="day" style="margin-left: 100px;" checked> <label style="display:inline-block; font-weight: 500;">Day</label>&nbsp;&nbsp;<form style="display:inline-block"><input id= "recurrPatternIn" type="text" size="3" style="width:205px;"></form><label style="display:inline-block; font-weight: 500;"> of every month</label></br><input type="radio" name ="month" value="the" style="margin-left: 100px;"> <label style="display:inline-block; font-weight: 500;">The</label>&nbsp;&nbsp;<select id="monthOpt1Select">'+D+'</select><select id="monthOpt2Select">'+T+'</select><label style=" font-weight: 500;"> of every month</label></div><div id="patternYear" ><input id ="yearRadio" type="radio" name ="year" value="month" style="margin-left: 100px;" checked> <label style="display:inline-block; font-weight: 500;">Every</label>&nbsp;<select id="yearEveryMonth">'+w+'</select><input id="yearDayMonth"type="text" size="3"></br><input type="radio" name ="year" value="the" style="margin-left: 100px;"> <label style="display:inline-block; font-weight: 500;">The</label>&nbsp;<select id="yearOpt1Select">'+D+'</select><select id="yearOpt2Select">'+T+'</select><label style=" font-weight: 500;">of&nbsp;&nbsp;</label><select id="yearMonthSelect">'+w+"</select></div></div>",B='<div id="rangeOfRecurrDiv" style="display:none"><br><span class="dialog-title"><strong>Range of Recurrence:</strong> </span><form><span class="dialog-label">Start:</span><input type="text" id="rangeStartIn"></form><form><span class="dialog-label">End:</span><input type="radio" name ="end" value="noEnd" checked> No end date</br><input type="radio" name ="end" value ="endBy" id="endByRadio" style="margin-left:100px;"> End by:&nbsp;&nbsp;<input id= "endByIn" type="text" style="width:187px;"></form></div>',H='<div id="rangeOfRecurrOnceDiv"><form><span class="dialog-label">Start Date:</span><input id= "startDateIn" type="text" value=""></form></div>',J='<div id="mailQuestionDiv"><label>Would you like to email a copy when the schedule runs?</label><br><input type="radio" name="mailRadio" value="no" id="mailRadioNo" checked onclick=\'showHideMailDiv()\'>&nbsp;No&nbsp;&nbsp;</input><input type="radio" name="mailRadio" value="yes" id="mailRadioYes" onclick=\'showHideMailDiv(true)\'>&nbsp;Yes&nbsp;&nbsp;</input></div>',j='<div id="mailInfoDiv" style="display:none"><label>To: (Use a semi-colon or comma to separate multiple email adresses.)</label><form><input id="toInput" style="width:100%" type="text"></input></form><label>Subject:</label><form><input id="subjectInput" style="width:100%" type="text" value="'+l()+' schedule has successfully run."></input></form><label>Attachment Name:</label><form><input id="attachmentNameInput" style="width:100%" type="text" value="'+a("#nameIn").val()+'"></input></form><label>Message (optional)</label><textarea id="messageInput" type="text" rows="4" style="width:100%"></textarea></div>',Y=function(t){var i=S.outputTarget?S.outputTarget:"table/html;page-mode=page",r=new Array,o=0;
r[o++]=I("output-target",i,"string",!0),r[o++]=I("accepted-page","0","string"),r[o++]=I("showParameters","true","string"),r[o++]=I("renderMode","XML","string"),r[o++]=I("htmlProportionalWidth","false","string"),t&&(r[o++]=I("_SCH_EMAIL_TO",a("#toInput").val(),"string"),r[o++]=I("_SCH_EMAIL_CC","","string"),r[o++]=I("_SCH_EMAIL_BCC","","string"),r[o++]=I("_SCH_EMAIL_SUBJECT",a("#subjectInput").val(),"string"),r[o++]=I("_SCH_EMAIL_MESSAGE",a("#messageInput").val(),"string"),r[o++]=I("_SCH_EMAIL_ATTACHMENT_NAME",a("#attachmentNameInput").val(),"string"));
for(var l=0;l<S.parameters.length;l++)r[o++]=I(S.parameters[l][0],S.parameters[l][1],"string",!0);
n.jobParameters=r;var s=!1,d=a.ajaxSettings.async;return a.ajaxSetup({async:!1}),a.ajax({url:e.getScheduledJob(),type:"POST",data:JSON.stringify(n),contentType:"application/json",success:function(){alert("Successfully scheduled."),s=!0
},error:function(e){alert(e.responseText),s=!1}}),a.ajaxSetup({async:d}),s},L=P+C+O+M+A+_+B+H,W=J+j,z=!1;
a.ajax({type:"GET",url:e.getEmailConfig()+"/isValid",success:function(e){z=e}});var F={basicState:{html:L,title:"Schedule Report",buttons:{Cancel:-1,Ok:1},submit:function(e,o){if(t=r(),-1==o)a.prompt.close();
else if(1==o)return k(),i?(n={},!1):z?(a("#attachmentNameInput").val(a("#nameIn").val()),a.prompt.goToState("mailState"),!1):Y()
}},mailState:{html:W,title:"Schedule Report",buttons:{Back:-1,Ok:1},submit:function(e,t){if(-1==t)return a.prompt.goToState("basicState"),!1;
if(1==t){if(a("#mailRadioNo").is(":checked"))return Y();if(a("#mailRadioYes").is(":checked")){var n=/^\S+@\S+$/;
return a("#toInput").val().match(n)?Y(!0):(o("Invalid email","#toInput"),!1)}return!1
}}}};a.prompt(F,{classes:"scheduler"}),a(".scheduler #jqi").css("width","510px"),a(document).ready(function(){a("#startDateIn").datepicker({minDate:0}),a("#rangeStartIn").datepicker({minDate:0}),a("#endByIn").datepicker({minDate:0}),a("#startDateIn").datepicker("setDate",new Date),a("#rangeStartIn").datepicker("setDate",new Date)
})}});return n});